<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Descargador de Archivos</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<!-- Pre-SDK handler to suppress early unhandled promise rejections from network errors -->
<script>
  window.addEventListener('unhandledrejection', function(e){
    try{
      var r = e && e.reason;
      var msg = (r && (r.message || r.toString())) || '';
      if(String(msg).toLowerCase().includes('network')){
        e.preventDefault();
      }
    }catch(_){}
  });
</script>
<!-- Monetag / Ad SDK -->
<script src='//libtl.com/sdk.js' data-zone='10050170' data-sdk='show_10050170'></script>
<style>
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.8s ease-out forwards; }
.slide-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; }
.animation-delay-200 { animation-delay: 0.2s; }
.animation-delay-400 { animation-delay: 0.4s; }
.slider-container { position: relative; overflow: hidden; }
.slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
.slider-item { min-width: 100%; box-sizing: border-box; }
.slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
.slider-dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s; }
.slider-dot.active { background-color: white; }
body { scrollbar-width: none; }
body::-webkit-scrollbar { display: none; }
.ad-counter { font-size: 0.9rem; font-weight: 600; margin-left: 0.5rem; color: #fbbf24; }
</style>
</head>
<body class="bg-gray-50 font-sans">

<div id="app" class="container mx-auto p-4 max-w-7xl">
<header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-xl shadow-lg mb-8 fade-in">
<h1 data-key="main_title" class="text-4xl font-extrabold text-center mb-4">Webapp Sikho</h1>
<p data-key="main_subtitle" class="text-center text-lg text-blue-100 mb-6">¡Mira anuncios, desbloquea y descarga archivos gratis!</p>
<div class="max-w-2xl mx-auto">
<div class="relative">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="fas fa-search text-gray-400"></i>
</div>
<input type="text" id="searchInput" data-key-placeholder="search_placeholder" placeholder="Buscar archivos..." class="w-full p-3 pl-10 rounded-full bg-white text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-shadow duration-300">
</div>
</div>
</header>

<div id="ad-container-1" class="my-6 flex justify-center min-h-[50px]"></div>

<div id="slider" class="slider-container w-full h-48 md:h-80 bg-gray-300 rounded-xl shadow-lg mb-10 slide-up animation-delay-200">
<div id="slider-wrapper" class="slider-wrapper h-full"></div>
<div id="slider-dots" class="slider-dots"></div>
</div>

<div id="ad-container-2" class="my-6 flex justify-center min-h-[50px]"></div>

<div class="slide-up animation-delay-400">
<h2 data-key="available_files" class="text-3xl font-bold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2">Archivos disponibles</h2>
<div id="files-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
<div id="no-results" class="hidden text-center py-12">
<i class="fas fa-file-excel text-5xl text-gray-400 mb-4"></i>
<p data-key="no_results_text" class="text-xl text-gray-600">No se encontraron archivos que coincidan con tu búsqueda.</p>
</div>
</div>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-2xl opacity-0 transform translate-y-10 transition-all duration-500">
<p id="toast-message"></p>
</div>

<div id="language-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
<div class="bg-white p-8 rounded-lg shadow-2xl text-center fade-in">
<h2 class="text-2xl font-bold mb-6">Elige tu idioma</h2>
<div class="flex flex-col sm:flex-row justify-center gap-4">
<button class="lang-btn px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors" data-lang="es">Español</button>
<button class="lang-btn px-6 py-3 bg-blue-400 text-white rounded-lg font-semibold hover:bg-blue-500 transition-colors" data-lang="en">English</button>
</div>
</div>
</div>

<footer class="bg-gray-100 py-6 mt-10">
<div class="container mx-auto px-4">
<div id="ad-container-3" class="my-4 flex justify-center min-h-[50px]"></div>
<p class="text-center text-gray-600">&copy; 2025 Webapp Sikho. Todos los derechos reservados.</p>
</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDcnQLf0jauZZBrQbbU3st-J9_Avk47eD8",
    authDomain: "up-donwloader-tools.firebaseapp.com",
    databaseURL: "https://up-donwloader-tools-default-rtdb.firebaseio.com",
    projectId: "up-donwloader-tools",
    storageBucket: "up-donwloader-tools.firebasestorage.app",
    messagingSenderId: "332640288741",
    appId: "1:332640288741:web:ca02520aa0791ee4d5b90c",
    measurementId: "G-ZZMHRVHEGY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const filesGrid = document.getElementById('files-grid');
const searchInput = document.getElementById('searchInput');
const noResultsMessage = document.getElementById('no-results');
const languageModal = document.getElementById('language-modal');
let currentLang = 'es';
let timerDuration = 10;

// Catch unhandled promise rejections from third-party SDKs and surface a friendly toast
window.addEventListener('unhandledrejection', (e)=>{
    const msg = (e && e.reason && (e.reason.message||e.reason.toString())) || '';
    if(String(msg).toLowerCase().includes('network')){
        e.preventDefault();
        try{ showToast('toast_ad_error'); }catch(_){/* ignore */}
    }
});

async function loadTimerSetting(){
    try{
        const snap = await getDoc(doc(db, "settings", "general"));
        if(snap.exists()){
            const val = parseInt(snap.data().timerDuration);
            if(!Number.isNaN(val) && val >= 0) timerDuration = val;
        }
    }catch(_){/* ignore */}
}

function getAdFn(){
    if(typeof window !== 'undefined' && typeof window.show_10050170 === 'function') return window.show_10050170;
    return null;
}

function ensureAdSdkReady(timeoutMs=7000){
    return new Promise((resolve)=>{
        const existing = getAdFn();
        if(existing){ resolve(existing); return; }
        let done = false;
        const finish = (fn)=>{ if(!done){ done = true; resolve(fn||null); } };
        const t = setTimeout(()=>finish(getAdFn()), timeoutMs);
        const iv = setInterval(()=>{
            const fn = getAdFn();
            if(fn){ clearInterval(iv); clearTimeout(t); finish(fn); }
        }, 150);
    });
}

function getCooldownRemaining(fileId){
    const next = parseInt(localStorage.getItem(`nextAllowed_${fileId}`) || '0');
    const now = Date.now();
    return Math.max(0, Math.ceil((next - now)/1000));
}

function startCooldown(button, seconds){
    const fileId = button.dataset.id;
    const btnLabelEl = button.querySelector('span');
    const counterEl = document.getElementById(`counter-${fileId}`);
    button.disabled = true;
    let remainingInit = Math.max(seconds, getCooldownRemaining(fileId));
    btnLabelEl.textContent = getText('verifying_button',{countdown:remainingInit});
    if(button.dataset.cooldown === '1'){ return; }
    button.dataset.cooldown = '1';
    const iv = setInterval(()=>{
        const remaining = getCooldownRemaining(fileId);
        btnLabelEl.textContent = getText('verifying_button',{countdown:remaining});
        if(counterEl){
            const requiredCount=parseInt(button.dataset.requiredAds);
            let adCount=parseInt(localStorage.getItem(`adCount_${fileId}`)||0);
            counterEl.textContent = `${adCount}/${requiredCount} Ads · ${remaining}s`;
        }
        if(remaining === 0){
            clearInterval(iv);
            button.disabled = false;
            updateButtonState(button);
            delete button.dataset.cooldown;
        }
    }, 1000);
}

const translations = {
es: {
main_title: "Webapp Sikho",
main_subtitle: "¡Mira anuncios, desbloquea y descarga archivos gratis!",
search_placeholder: "Buscar archivos...",
available_files: "Archivos disponibles",
no_results_text: "No se encontraron archivos que coincidan con tu búsqueda.",
unlock_button: "Desbloquear ({adCount}/{requiredCount})",
download_now_button: "Descargar ahora",
toast_download_starting: "Tu descarga está comenzando...",
toast_progress: "Progreso: {adCount}/{requiredCount}",
toast_unlocked: "¡Descarga desbloqueada!",
toast_ad_error: "No se pudo cargar el anuncio. Intenta de nuevo.",
loading_ad: "Cargando anuncio...",
verifying_button: "Espera {countdown}s"
},
en: {
main_title: "Webapp Sikho",
main_subtitle: "Watch ads, unlock, and download files for free!",
search_placeholder: "Search for files...",
available_files: "Available Files",
no_results_text: "No files found matching your search.",
unlock_button: "Unlock ({adCount}/{requiredCount})",
download_now_button: "Download Now",
toast_download_starting: "Your download is starting...",
toast_progress: "Progress: {adCount}/{requiredCount}",
toast_unlocked: "Download unlocked!",
toast_ad_error: "Could not load ad. Please try again.",
loading_ad: "Loading ad...",
verifying_button: "Please wait {countdown}s"
}
};

function applyLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    localStorage.setItem('userLanguage', lang);
    document.querySelectorAll('[data-key]').forEach(elem => {
        const key = elem.getAttribute('data-key');
        if (translations[lang][key]) elem.textContent = translations[lang][key];
    });
    document.querySelectorAll('[data-key-placeholder]').forEach(elem => {
        const key = elem.getAttribute('data-key-placeholder');
        if (translations[lang][key]) elem.placeholder = translations[lang][key];
    });
    languageModal.classList.add('hidden');
    loadUserPageData();
}

function getText(key, params={}) {
    let text = translations[currentLang][key] || key;
    for (const param in params) text = text.replace(`{${param}}`, params[param]);
    return text;
}

function showToast(key, params={}) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    toastMessage.textContent = getText(key, params);
    toast.classList.remove('opacity-0','translate-y-10');
    setTimeout(()=>{toast.classList.add('opacity-0','translate-y-10');},3000);
}

async function loadUserPageData() {
    try {
        const q = query(collection(db,"files"));
        const filesSnapshot = await getDocs(q);
        filesGrid.innerHTML='';
        if(filesSnapshot.empty){
            filesGrid.innerHTML=`<p class="col-span-full text-center text-gray-500">No files uploaded</p>`;
            return;
        }
        filesSnapshot.forEach(doc=>{
            const file={id:doc.id,...doc.data()};
            const card=document.createElement('div');
            card.className='file-card bg-white rounded-xl shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 hover:shadow-xl';
            card.innerHTML=`
            <img src="${file.thumbnailUrl}" alt="${file.title}" class="w-full aspect-video object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x225/cccccc/ffffff?text=Sin+imagen';">
            <div class="p-4">
            <h3 class="text-lg font-bold text-gray-900 truncate" title="${file.title}">${file.title}</h3>
            <p class="text-gray-600 text-sm mt-1 h-10 overflow-hidden">${file.description}</p>
            <div class="flex items-center gap-2">
            <button data-id="${file.id}" data-url="${file.downloadUrl}" data-required-ads="${file.requiredAds || 10}" class="download-btn w-full mt-4 py-2.5 px-4 rounded-lg text-white font-semibold transition-all duration-300 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
            <i class="fas"></i><span></span></button>
            <span class="ad-counter" id="counter-${file.id}"></span>
            </div>
            </div>
            `;
            filesGrid.appendChild(card);
            const btn = card.querySelector('.download-btn');
            updateButtonState(btn);
            const rem = getCooldownRemaining(file.id);
            if(rem > 0){ startCooldown(btn, rem); }
        });
    } catch(e){console.error(e);filesGrid.innerHTML=`<p class="col-span-full text-center text-red-500">Error loading files</p>`;}
}

function updateButtonState(button){
    const fileId=button.dataset.id;
    const requiredCount=parseInt(button.dataset.requiredAds);
    let adCount=parseInt(localStorage.getItem(`adCount_${fileId}`)||0);
    const isUnlocked=adCount>=requiredCount;
    const buttonTextEl=button.querySelector('span');
    const buttonIconEl=button.querySelector('i');
    const counterEl=document.getElementById(`counter-${fileId}`);
    const lockedColors=['bg-gradient-to-r','from-blue-500','to-purple-600'];
    const unlockedColors=['bg-gradient-to-r','from-green-400','to-green-600'];
    button.classList.remove(...lockedColors,...unlockedColors);
    if(isUnlocked){
        buttonTextEl.textContent=getText('download_now_button');
        buttonIconEl.className='fas fa-download';
        counterEl.textContent='';
        button.classList.add(...unlockedColors);
        button.disabled = false;
    }else{
        const remaining = getCooldownRemaining(fileId);
        if(remaining > 0){
            buttonTextEl.textContent=getText('verifying_button',{countdown:remaining});
            buttonIconEl.className='fas fa-hourglass-half';
            button.disabled = true;
            if(counterEl){
                counterEl.textContent = `${adCount}/${requiredCount} Ads · ${remaining}s`;
            }
        }else{
            buttonTextEl.textContent=getText('unlock_button',{adCount,requiredCount});
            buttonIconEl.className='fas fa-lock';
            button.disabled = false;
            if(counterEl){
                counterEl.textContent=`${adCount}/${requiredCount} Ads`;
            }
        }
        button.classList.add(...lockedColors);
    }
}

filesGrid.addEventListener('click', async e=>{
    const btn=e.target.closest('.download-btn');
    if(!btn) return;
    const fileId=btn.dataset.id;
    const downloadUrl=btn.dataset.url;
    const requiredCount=parseInt(btn.dataset.requiredAds);
    let adCount=parseInt(localStorage.getItem(`adCount_${fileId}`)||0);

    if(adCount>=requiredCount){
        showToast('toast_download_starting');
        window.open(downloadUrl,'_blank');
        return;
    }

    const coolRem = getCooldownRemaining(fileId);
    if(coolRem > 0){
        startCooldown(btn, coolRem);
        return;
    }

    try{
        btn.disabled = true;
        const label = btn.querySelector('span');
        label.textContent = getText('loading_ad');
        let adFn = await ensureAdSdkReady(7000);
        if(!adFn){
            // one quick retry
            adFn = await ensureAdSdkReady(2000);
        }
        if(!adFn){ btn.disabled = false; updateButtonState(btn); showToast('toast_ad_error'); return; }
        // Disable button while ad is being shown to prevent double clicks
        let settled = false;
        const fallbackMs = Math.max(3000, Math.min(10000, timerDuration*1000));
        const fallback = setTimeout(()=>{
            if(settled) return;
            settled = true;
            // Assume ad watched as fallback, increment progress and start cooldown
            adCount++;
            localStorage.setItem(`adCount_${fileId}`,adCount);
            if(adCount>=requiredCount){
                updateButtonState(btn);
                btn.disabled = false;
                showToast('toast_unlocked');
            } else {
                const next = Date.now() + (timerDuration*1000);
                localStorage.setItem(`nextAllowed_${fileId}`, String(next));
                updateButtonState(btn);
                startCooldown(btn, timerDuration);
                showToast('toast_progress',{adCount,requiredCount});
            }
        }, fallbackMs);

        Promise.resolve(adFn({
            onClose:()=>{
                if(!settled){
                    settled = true; clearTimeout(fallback);
                    adCount++;
                    localStorage.setItem(`adCount_${fileId}`,adCount);
                    if(adCount>=requiredCount){
                        updateButtonState(btn);
                        btn.disabled = false;
                        showToast('toast_unlocked');
                    } else {
                        const next = Date.now() + (timerDuration*1000);
                        localStorage.setItem(`nextAllowed_${fileId}`, String(next));
                        updateButtonState(btn);
                        startCooldown(btn, timerDuration);
                        showToast('toast_progress',{adCount,requiredCount});
                    }
                }
            },
            onError:()=>{
                if(!settled){
                    settled = true; clearTimeout(fallback);
                    btn.disabled = false;
                    showToast('toast_ad_error');
                }
            }
        })).catch(()=>{
            if(!settled){
                settled = true; clearTimeout(fallback);
                btn.disabled = false;
                showToast('toast_ad_error');
            }
        });
    }catch(err){
        console.error(err);
        btn.disabled = false;
        showToast('toast_ad_error');
    }
});

searchInput.addEventListener('keyup',()=>{
    const term=searchInput.value.toLowerCase();
    const cards=document.querySelectorAll('.file-card');
    let visible=0;
    cards.forEach(c=>{
        const title=c.querySelector('h3').textContent.toLowerCase();
        const desc=c.querySelector('p').textContent.toLowerCase();
        if(title.includes(term)||desc.includes(term)){c.style.display='block';visible++;}
        else c.style.display='none';
    });
    noResultsMessage.style.display=visible===0?'block':'none';
});

window.addEventListener('load', async ()=>{
    const lang=localStorage.getItem('userLanguage')||'es';
    await loadTimerSetting();
    applyLanguage(lang);
    // Global cooldown ticker to ensure countdown always advances
    setInterval(()=>{
        document.querySelectorAll('.download-btn').forEach(btn=>{
            const fileId = btn.dataset.id;
            if(!fileId) return;
            const rem = getCooldownRemaining(fileId);
            const counterEl = document.getElementById(`counter-${fileId}`);
            const requiredCount=parseInt(btn.dataset.requiredAds);
            let adCount=parseInt(localStorage.getItem(`adCount_${fileId}`)||0);
            if(rem > 0){
                btn.disabled = true;
                const btnLabelEl = btn.querySelector('span');
                btnLabelEl.textContent = getText('verifying_button',{countdown:rem});
                if(counterEl){ counterEl.textContent = `${adCount}/${requiredCount} Ads · ${rem}s`; }
            }else{
                // Only reset state if not unlocked
                if(adCount < requiredCount){
                    btn.disabled = false;
                }
                updateButtonState(btn);
            }
        });
    }, 1000);
});

document.querySelectorAll('.lang-btn').forEach(btn=>{btn.addEventListener('click',()=>applyLanguage(btn.dataset.lang));});
</script>

</body>
</html>
